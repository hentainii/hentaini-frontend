# Plan de MigraciÃ³n del Sistema Uploader de PHP a Nuxt.js

## Objetivo
Migrar el sistema de subida de archivos (Uploader) desde PHP a Nuxt.js para integrarlo en la interfaz de creaciÃ³n de episodios (`Episode.vue`). El sistema debe ser capaz de subir videos a mÃºltiples servidores APIs y obtener los cÃ³digos de respuesta para poblar automÃ¡ticamente los campos de players.

## AnÃ¡lisis del Sistema Legacy

### Componentes Identificados:
1. **Frontend Legacy**: Interfaz en `serie-episode-create.php` (lÃ­neas 221-273)
2. **JavaScript Legacy**: LÃ³gica de upload (lÃ­neas 274-614)
3. **Handlers PHP**: Varios manejadores en `legacy-uploader/uploader/`
   - `mp4upload-handler.php`
   - `vhide-handler.php` 
   - `STREAM2-handler.php`
   - `yourupload-uploadfile.php` y `yourupload-getfolder.php`
4. **Sistema de Accounts**: Tabla `accounts` que gestiona credenciales por servicio
5. **Player Management**: Sistema de players con campos `api_key` y `up_available`

## Estructura de Base de Datos (STRAPI)

### Tabla `players` (existente - a extender):
- `id` (auto)
- `name` (string)
- `short_name` (string) 
- `player_code` (text)
- `up_available` (boolean) - **NUEVO** - indica si estÃ¡ disponible para upload
- `createdAt`, `updatedAt` (auto)

### Tabla `accounts` (nueva):
- `id` (auto)
- `service` (string) - nombre del servicio (M, YourUpload, Mp4upload, VHide, STREAM2)
- `username` (string) - usuario para el servicio (algunas cuentas requieres username y no email)
- `password` (string) - contraseÃ±a para el servicio  
- `email` (string) - email para el servicio (algunas cuentas requiere email y no username)
- `api_key` (string) - clave API del servicio (algunas cuentas no requiren ni email ni username, solo una api_key)
- `player` (relation) - relaciÃ³n con tabla players (many-to-one)
- `createdAt`, `updatedAt` (auto)

## Plan de ImplementaciÃ³n

### Fase 1: PreparaciÃ³n de Base de Datos (STRAPI Backend - Repositorio Separado)
- [x] **Tarea 1.1**: Analizar estructura actual de tabla `players`
- [X] **Tarea 1.2**: AÃ±adir campo `up_available` (boolean) a Content Type `players` 
- [X] **Tarea 1.3**: Crear Content Type `accounts` con campos:
  - `service` (Text)
  - `username` (Text)  
  - `password` (Text)
  - `email` (Email)
  - `api_key` (Text)
  - `player` (Relation - Many-to-One con players)
- [X] **Tarea 1.4**: Configurar permisos en STRAPI para endpoints de accounts

### Fase 2: Frontend Store Extensions (Nuxt.js)
- [x] **Tarea 2.1**: Extender `store/players.js` para incluir gestiÃ³n de accounts
- [x] **Tarea 2.2**: Crear `store/uploader.js` para gestionar estado de uploads
- [x] **Tarea 2.3**: Implementar actions en stores para:
  - [x] Obtener players con accounts (populate accounts)
  - [x] Gestionar estado de uploads mÃºltiples
  - [x] Trackear progreso de uploads
  - [x] Manejar respuestas y errores de uploads

### Fase 3: Upload Handlers (Cliente - JavaScript Modules)
- [x] **Tarea 3.1**: Crear `composables/uploader/` directory
- [x] **Tarea 3.2**: Crear handlers de upload para cada servicio:
  - [x] `mp4upload.js` - usando formularios multipart chunked
  - [ ] `vhide.js` - usando API keys 
  - [ ] `stream2.js` - usando API keys
  - [ ] `yourupload.js` - usando autenticaciÃ³n de sesiÃ³n
  - [x] `mega.js` - usando MegaJS library del CDN
- [x] **Tarea 3.3**: Crear `uploadManager.js` para coordinar uploads mÃºltiples
- [x] **Tarea 3.4**: Implementar upload por chunks para archivos grandes
- [x] **Tarea 3.5**: Implementar sistema de retry para uploads fallidos

### Fase 4: Frontend Components
- [x] **Tarea 4.1**: Actualizar `components/Uploader/Main.vue` con nueva funcionalidad
- [x] **Tarea 4.2**: Crear componentes adicionales:
  - [x] `components/Uploader/ProgressCard.vue` - progreso por servicio
  - [ ] `components/Uploader/FileSelector.vue` - selector con drag&drop
  - [ ] `components/Uploader/RetryButton.vue` - botÃ³n retry por servicio
- [x] **Tarea 4.3**: Integrar uploader en `components/Create/Episode.vue`
- [x] **Tarea 4.4**: AÃ±adir sistema de notificaciones para estado de uploads

### Fase 5: IntegraciÃ³n y UX
- [x] **Tarea 5.1**: Integrar uploader con formulario de Episode
- [x] **Tarea 5.2**: Auto-poblar campos de players con cÃ³digos obtenidos
- [x] **Tarea 5.3**: Implementar validaciones de archivos (tipo, tamaÃ±o)
- [x] **Tarea 5.4**: AÃ±adir preview de video antes de upload (drag & drop implementado)
- [x] **Tarea 5.5**: Implementar sistema de templates de players (Airing Model, Finished Model - ya existente)

### Fase 6: Testing y OptimizaciÃ³n
- [ ] **Tarea 6.1**: Testing de uploads por chunks
- [ ] **Tarea 6.2**: Testing de mÃºltiples uploads simultÃ¡neos
- [ ] **Tarea 6.3**: Testing de sistema de retry
- [ ] **Tarea 6.4**: OptimizaciÃ³n de performance
- [ ] **Tarea 6.5**: Testing de integraciÃ³n con Episode creation

## Estado Actual de ImplementaciÃ³n

### âœ… Completado:
1. **Stores Vuex**: `accounts.js`, `uploader.js` y extensiÃ³n de `players.js`
2. **Upload Handlers**: Mega y Mp4upload (con proxies backend)
3. **Upload Manager**: CoordinaciÃ³n de uploads mÃºltiples con retry logic
4. **Utilities**: Chunked upload y retry logic con backoff exponencial
5. **Componentes UI**: `UploaderMain.vue` y `UploaderProgressCard.vue`
6. **IntegraciÃ³n**: Uploader integrado en `Episode.vue` con auto-population
7. **Backend STRAPI**: ConfiguraciÃ³n de Content Types (repositorio separado)

### ğŸ”„ En Progreso/Falta:
2. **Handlers adicionales**: YourUpload, VHide, STREAM2
3. **Testing completo**: Todas las fases de testing
4. **Componentes opcionales**: FileSelector y RetryButton especÃ­ficos

### ğŸ“ Notas de ImplementaciÃ³n:

#### Mega Upload:
- âœ… Implementado con MegaJS desde CDN
- âœ… Progress tracking real
- âœ… Manejo de errores robusto

#### Mp4upload:
- âœ… Implementado con chunked upload
- âš ï¸ Requiere backend proxy debido a CORS
- âœ… Fallback directo (limitado por CORS)

#### Upload Manager:
- âœ… Queue system para controlar concurrencia
- âœ… Priority-based uploading
- âœ… Retry logic con exponential backoff
- âœ… Auto-population de episode players

#### UI/UX:
- âœ… Drag & drop file selection
- âœ… Real-time progress tracking
- âœ… Service-specific progress cards
- âœ… Error handling y retry buttons
- âœ… Integration con Episode creation flow

## Arquitectura TÃ©cnica

### Estructura de Directorios Propuesta:
```
store/
â”œâ”€â”€ uploader.js                  # Estado global del uploader âœ…
â”œâ”€â”€ players.js                   # Extendido con gestiÃ³n de accounts âœ…
â””â”€â”€ accounts.js                  # GestiÃ³n especÃ­fica de accounts âœ…

composables/
â””â”€â”€ uploader/
    â”œâ”€â”€ uploadManager.js         # Coordinador de uploads mÃºltiples âœ…
    â”œâ”€â”€ handlers/
    â”‚   â”œâ”€â”€ mp4upload.js âœ…
    â”‚   â”œâ”€â”€ vhide.js â³
    â”‚   â”œâ”€â”€ stream2.js â³
    â”‚   â”œâ”€â”€ yourupload.js â³
    â”‚   â””â”€â”€ mega.js âœ…
    â””â”€â”€ utils/
        â”œâ”€â”€ chunkedUpload.js     # Utilidad para uploads por chunks âœ…
        â””â”€â”€ retryLogic.js        # LÃ³gica de reintentos âœ…

components/
â”œâ”€â”€ Uploader/
â”‚   â”œâ”€â”€ Main.vue                 # Componente principal âœ…
â”‚   â”œâ”€â”€ ProgressCard.vue         # Card de progreso por servicio âœ…
â”‚   â”œâ”€â”€ FileSelector.vue         # Selector de archivos con drag&drop â³
â”‚   â””â”€â”€ RetryButton.vue          # BotÃ³n de retry por servicio â³
```

### Flujo de Datos (STRAPI Integration):
1. **Carga inicial**: `store/players.js` llama a STRAPI `/players?populate=accounts` âœ…
2. **SelecciÃ³n de archivo**: Usuario selecciona archivo en `Episode.vue` âœ…
3. **Filtrado de servicios**: Se filtran players con `up_available: true` y sus accounts activas âœ…
4. **Upload paralelo**: `uploadManager.js` inicia uploads a servicios disponibles âœ…
5. **Progress tracking**: Cada handler reporta progreso a `store/uploader.js` âœ…
6. **Auto-poblaciÃ³n**: CÃ³digos obtenidos se insertan en campos de players del episodio âœ…
7. **Retry capability**: Sistema permite reintentar uploads fallidos âœ…
8. **Submit final**: Formulario de Episode listo para envÃ­o âœ…

### STRAPI API Calls (siguiendo patrÃ³n de series.js):
```javascript
// store/players.js - extendido âœ…
async getPlayersWithAccounts({ commit }, payload) {
  const qs = require('qs')
  const query = qs.stringify({
    populate: ['accounts'],
    filters: {
      up_available: true
    }
  }, { encodeValuesOnly: true })
  
  await fetch(`${this.$config.API_STRAPI_ENDPOINT}players?${query}`, {
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${payload.token}`
    }
  })
  .then(res => res.json())
  .then((players) => {
    commit('getPlayersWithAccounts', players)
  })
}

// store/accounts.js - nuevo âœ…
async getAvailableAccounts({ commit }, payload) {
  const qs = require('qs')
  const query = qs.stringify({
    populate: ['player'],
    filters: {
      up_available: true
    }
  }, { encodeValuesOnly: true })
  
  await fetch(`${this.$config.API_STRAPI_ENDPOINT}accounts?${query}`, {
    headers: {
      'Content-Type': 'application/json', 
      Authorization: `Bearer ${payload.token}`
    }
  })
  .then(res => res.json())
  .then((accounts) => {
    commit('getAvailableAccounts', accounts)
  })
}
```

### TecnologÃ­as a Utilizar:
- **Frontend**: Vue.js + Vuetify (ya implementado) âœ…
- **Upload Libraries**: Axios para HTTP, FormData para chunks âœ…
- **State Management**: Vuex (ya implementado) âœ…
- **File Handling**: FileReader API, Blob handling âœ…
- **Progress Tracking**: Reactive state con Vuex âœ…
- **External APIs**: 
  - MegaJS para Mega (CDN import) âœ…
  - Fetch/Axios para resto de servicios âœ…
- **Backend**: STRAPI (repositorio separado) â³

## Consideraciones TÃ©cnicas

### Chunked Upload:
- Dividir archivos en chunks de 1MB para mejor handling âœ…
- Implementar resume capability para uploads interrumpidos â³
- Manejar timeout y retry logic por chunk âœ…

### Security:
- Validar tipos de archivo permitidos (.mp4) âœ…
- LÃ­mites de tamaÃ±o de archivo âœ…
- SanitizaciÃ³n de nombres de archivo âœ…
- Credentials manejadas desde STRAPI backend â³

### Performance:
- Uploads paralelos pero controlados (max 3-5 simultÃ¡neos) âœ…
- Progress indicators precisos âœ…
- GestiÃ³n de memoria para archivos grandes âœ…
- Lazy loading de libraries pesadas (MegaJS) âœ…

### Error Handling:
- Retry automÃ¡tico con backoff exponencial âœ…
- Logging detallado de errores âœ…
- Fallback a otros servicios si uno falla âœ…
- User-friendly error messages âœ…
- Estado persistente de uploads en progreso âœ…

## Timeline Estimado
- **Fase 1**: 1 dÃ­a (Backend STRAPI - repositorio separado) â³
- **Fase 2**: 1-2 dÃ­as (Store extensions) âœ…
- **Fase 3**: 3-4 dÃ­as (Upload handlers) âœ… (2/5 handlers completados)
- **Fase 4**: 2-3 dÃ­as (Frontend components) âœ…
- **Fase 5**: 2 dÃ­as (IntegraciÃ³n UX) âœ…
- **Fase 6**: 1-2 dÃ­as (Testing) â³

**Total**: 10-14 dÃ­as de desarrollo (**~70% completado**)

## Riesgos y Mitigaciones
- **Riesgo**: APIs externas pueden cambiar
  - **MitigaciÃ³n**: Crear abstracciÃ³n layer, logging detallado âœ…
- **Riesgo**: Uploads grandes pueden fallar  
  - **MitigaciÃ³n**: Sistema de chunks + retry robusto âœ…
- **Riesgo**: Performance issues con mÃºltiples uploads
  - **MitigaciÃ³n**: Queue system, lÃ­mites de concurrencia âœ…
- **Riesgo**: CORS issues con external APIs
  - **MitigaciÃ³n**: Proxy patterns o server-side handling âš ï¸ (Requerido para Mp4upload, VHide, etc.)

## PrÃ³ximos Pasos

### Inmediatos:
1. **Backend STRAPI**: Configurar Content Types en repositorio backend
2. **Testing**: Probar el flujo completo con Mega uploads
3. **Handlers restantes**: Implementar YourUpload, VHide, STREAM2

### Mediano plazo:
1. **Backend proxies**: Implementar proxies para servicios con CORS
2. **Performance testing**: Validar con archivos de diferentes tamaÃ±os
3. **Error scenarios**: Testing de escenarios de error diversos

## Resultado Esperado
Un sistema de upload integrado y moderno que permita:
1. Subida automÃ¡tica a mÃºltiples servicios desde accounts configuradas en STRAPI âœ…
2. Progress tracking en tiempo real por servicio âœ…
3. Auto-population de campos de players en Episode creation âœ…
4. Retry capability para uploads fallidos âœ…
5. UX fluida integrada en el workflow de creaciÃ³n de episodios âœ…
6. GestiÃ³n centralizada de accounts y credentials desde panel admin â³











